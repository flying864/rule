# Clash Meta (Mihomo) ç»ˆæèåˆç‰ˆ
# ç»“åˆäº† Hans é…ç½®çš„ DNS åˆ†æµç­–ç•¥ä¸ WebRTC é˜²æŠ¤
# ä¿ç•™äº†ä½ çš„ RackNerd é“¾å¼ä»£ç†æ¶æ„

port: 7890
socks-port: 7891
mixed-port: 7893
allow-lan: true
mode: rule
log-level: warning
ipv6: false
external-controller: 0.0.0.0:9090

# æ€§èƒ½ä¼˜åŒ–å‚æ•°
unified-delay: true
tcp-concurrent: true
keep-alive-idle: 600
keep-alive-interval: 15
profile:
  store-selected: true
  store-fake-ip: true

# å—…æ¢ (ä¿æŒå…³é—­ï¼Œç¨³å®šç¬¬ä¸€)
sniffer:
  enable: false

# =========================
# 1. ä»£ç†é›†åˆ
# =========================
proxy-providers:
  All_Subscription:
    type: http
    # ğŸ‘‡ğŸ‘‡ğŸ‘‡ ä½ çš„å†…ç½‘è®¢é˜…é“¾æ¥ ğŸ‘‡ğŸ‘‡ğŸ‘‡
    url: "http://192.168.1.16:3001/DKzw7DRF8m92CeQnb3rg/download/collection/all?target=ClashMeta"
    interval: 86400
    path: ./proxies/all_sub.yaml
    health-check:
      enable: true
      interval: 600
      url: https://cp.cloudflare.com/generate_204

# =========================
# 2. è§„åˆ™é›†åˆ (æ··åˆæ¨¡å¼)
# =========================
rule-anchor:
  domain: &domain {type: http, interval: 86400, behavior: domain, format: mrs}
  ip: &ip {type: http, interval: 86400, behavior: ipcidr, format: mrs}

rule-providers:
  # è‡ªå®šä¹‰è§„åˆ™ (ä¿ç•™åŸæ ·)
  Flying_Direct:
    type: http
    behavior: classical
    url: "https://raw.githubusercontent.com/flying864/rule/refs/heads/main/config/openclash/Direct"
    path: ./rules/Flying_Direct.yaml
    interval: 28800

  Custom_Direct:
    type: http
    behavior: classical
    url: "https://raw.githubusercontent.com/Aethersailor/Custom_OpenClash_Rules/main/rule/Custom_Direct.list"
    path: ./rules/Custom_Direct.yaml
    interval: 28800

  Flying_Proxy:
    type: http
    behavior: classical
    url: "https://raw.githubusercontent.com/flying864/rule/refs/heads/main/config/openclash/Proxy"
    path: ./rules/Flying_Proxy.yaml
    interval: 28800

  Custom_Proxy:
    type: http
    behavior: classical
    url: "https://raw.githubusercontent.com/Aethersailor/Custom_OpenClash_Rules/main/rule/Custom_Proxy.list"
    path: ./rules/Custom_Proxy.yaml
    interval: 28800

  Steam_CDN:
    type: http
    behavior: classical
    url: "https://raw.githubusercontent.com/Aethersailor/Custom_OpenClash_Rules/main/rule/Steam_CDN.list"
    path: ./rules/Steam_CDN.yaml
    interval: 28800

  # MRS æé€Ÿè§„åˆ™
  private_domain: { <<: *domain, url: "https://raw.githubusercontent.com/MetaCubeX/meta-rules-dat/meta/geo/geosite/private.mrs"}
  youtube_domain: { <<: *domain, url: "https://raw.githubusercontent.com/MetaCubeX/meta-rules-dat/meta/geo/geosite/youtube.mrs"}
  google_domain: { <<: *domain, url: "https://raw.githubusercontent.com/MetaCubeX/meta-rules-dat/meta/geo/geosite/google.mrs"}
  github_domain: { <<: *domain, url: "https://raw.githubusercontent.com/MetaCubeX/meta-rules-dat/meta/geo/geosite/github.mrs"}
  telegram_domain: { <<: *domain, url: "https://raw.githubusercontent.com/MetaCubeX/meta-rules-dat/meta/geo/geosite/telegram.mrs"}
  netflix_domain: { <<: *domain, url: "https://raw.githubusercontent.com/MetaCubeX/meta-rules-dat/meta/geo/geosite/netflix.mrs"}
  apple_domain: { <<: *domain, url: "https://raw.githubusercontent.com/MetaCubeX/meta-rules-dat/meta/geo/geosite/apple.mrs"}
  microsoft_domain: { <<: *domain, url: "https://raw.githubusercontent.com/MetaCubeX/meta-rules-dat/meta/geo/geosite/microsoft.mrs"}
  cn_domain: { <<: *domain, url: "https://raw.githubusercontent.com/MetaCubeX/meta-rules-dat/meta/geo/geosite/cn.mrs"}
  geolocation-!cn: { <<: *domain, url: "https://raw.githubusercontent.com/MetaCubeX/meta-rules-dat/meta/geo/geosite/geolocation-!cn.mrs"}
  
  private_ip: {<<: *ip, url: "https://raw.githubusercontent.com/MetaCubeX/meta-rules-dat/meta/geo/geoip/private.mrs"}
  cn_ip: { <<: *ip, url: "https://raw.githubusercontent.com/MetaCubeX/meta-rules-dat/meta/geo/geoip/cn.mrs"}
  google_ip: { <<: *ip, url: "https://raw.githubusercontent.com/MetaCubeX/meta-rules-dat/meta/geo/geoip/google.mrs"}
  telegram_ip: { <<: *ip, url: "https://raw.githubusercontent.com/MetaCubeX/meta-rules-dat/meta/geo/geoip/telegram.mrs"}
  netflix_ip: { <<: *ip, url: "https://raw.githubusercontent.com/MetaCubeX/meta-rules-dat/meta/geo/geoip/netflix.mrs"}

# =========================
# 3. ç­–ç•¥ç»„
# =========================
g-test: &auto-test
  type: url-test
  url: "https://cp.cloudflare.com/generate_204"
  interval: 300
  tolerance: 50

proxy-groups:
  - name: "ğŸš€ æ‰‹åŠ¨é€‰æ‹©"
    type: select
    proxies:
      - "â™»ï¸ è‡ªåŠ¨é€‰æ‹©"
      - "ğŸ›¬ è½åœ°èŠ‚ç‚¹"
      - "ğŸ‡­ğŸ‡° é¦™æ¸¯èŠ‚ç‚¹"
      - "ğŸ‡¼ğŸ‡¸ å°æ¹¾èŠ‚ç‚¹"
      - "ğŸ‡ºğŸ‡¸ ç¾å›½èŠ‚ç‚¹"
      - "ğŸ‡¯ğŸ‡µ æ—¥æœ¬èŠ‚ç‚¹"
      - "ğŸ‡°ğŸ‡· éŸ©å›½èŠ‚ç‚¹"
      - "ğŸ‡¸ğŸ‡¬ æ–°åŠ å¡èŠ‚ç‚¹"
      - "ğŸ‡¬ğŸ‡§ è‹±å›½èŠ‚ç‚¹"
      - "ğŸ‡¨ğŸ‡¦ åŠ æ‹¿å¤§èŠ‚ç‚¹"
      - "ğŸ‡©ğŸ‡ª å¾·å›½èŠ‚ç‚¹"
      - "ğŸŒ å…¶ä»–åœ°åŒº"
      - "DIRECT"

  - name: "â™»ï¸ è‡ªåŠ¨é€‰æ‹©"
    <<: *auto-test
    use: [All_Subscription]
    filter: "^(?!.*(?i)racknerd).*"

  - name: "ğŸ›¬ è½åœ°èŠ‚ç‚¹"
    type: select
    use: [All_Subscription]
    filter: "(?i)racknerd"

  # --- åœ°åŒºåˆ†ç»„ ---
  - name: "ğŸ‡­ğŸ‡° é¦™æ¸¯èŠ‚ç‚¹"
    <<: *auto-test
    use: [All_Subscription]
    filter: "(?i)(æ¸¯|HK|Hong Kong)(?!.*racknerd)"

  - name: "ğŸ‡¼ğŸ‡¸ å°æ¹¾èŠ‚ç‚¹"
    <<: *auto-test
    use: [All_Subscription]
    filter: "(?i)(å°|TW|Taiwan|æ–°åŒ—|å½°åŒ–)(?!.*racknerd)"

  - name: "ğŸ‡ºğŸ‡¸ ç¾å›½èŠ‚ç‚¹"
    <<: *auto-test
    use: [All_Subscription]
    filter: "(?i)(ç¾|US|United States)(?!.*racknerd)"

  - name: "ğŸ‡¯ğŸ‡µ æ—¥æœ¬èŠ‚ç‚¹"
    <<: *auto-test
    use: [All_Subscription]
    filter: "(?i)(æ—¥æœ¬|JP|Japan)(?!.*racknerd)"

  - name: "ğŸ‡°ğŸ‡· éŸ©å›½èŠ‚ç‚¹"
    <<: *auto-test
    use: [All_Subscription]
    filter: "(?i)(éŸ©å›½|KR|Korea)(?!.*racknerd)"

  - name: "ğŸ‡¸ğŸ‡¬ æ–°åŠ å¡èŠ‚ç‚¹"
    <<: *auto-test
    use: [All_Subscription]
    filter: "(?i)(æ–°åŠ å¡|SG|Singapore)(?!.*racknerd)"
  
  - name: "ğŸ‡¬ğŸ‡§ è‹±å›½èŠ‚ç‚¹"
    <<: *auto-test
    use: [All_Subscription]
    filter: "(?i)(è‹±å›½|UK|Great Britain)(?!.*racknerd)"

  - name: "ğŸ‡¨ğŸ‡¦ åŠ æ‹¿å¤§èŠ‚ç‚¹"
    <<: *auto-test
    use: [All_Subscription]
    filter: "(?i)(åŠ |Canada|CA|Montreal|Vancouver)(?!.*racknerd)"

  - name: "ğŸ‡©ğŸ‡ª å¾·å›½èŠ‚ç‚¹"
    <<: *auto-test
    use: [All_Subscription]
    filter: "(?i)(å¾·|Germany|DE)(?!.*racknerd)"

  # --- åŠŸèƒ½åˆ†ç»„ ---
  - name: "ğŸ¥ Netflix"
    type: select
    use: [All_Subscription]
    filter: "(?i)(æµåª’ä½“|Netflix)"

  - name: "ğŸ è‹¹æœæœåŠ¡"
    type: select
    proxies: ["DIRECT", "ğŸš€ æ‰‹åŠ¨é€‰æ‹©"]

  - name: "â“‚ï¸ å¾®è½¯æœåŠ¡"
    type: select
    proxies: ["DIRECT", "ğŸš€ æ‰‹åŠ¨é€‰æ‹©"]

  - name: "ğŸ“¢ è°·æ­ŒFCM"
    type: select
    proxies: ["ğŸš€ æ‰‹åŠ¨é€‰æ‹©", "ğŸ‡ºğŸ‡¸ ç¾å›½èŠ‚ç‚¹", "ğŸ‡­ğŸ‡° é¦™æ¸¯èŠ‚ç‚¹", "ğŸ‡¼ğŸ‡¸ å°æ¹¾èŠ‚ç‚¹"]

  - name: "ğŸ‡¬ è°·æ­ŒæœåŠ¡"
    type: select
    proxies: ["ğŸš€ æ‰‹åŠ¨é€‰æ‹©", "ğŸ›¬ è½åœ°èŠ‚ç‚¹", "ğŸ‡­ğŸ‡° é¦™æ¸¯èŠ‚ç‚¹", "ğŸ‡¼ğŸ‡¸ å°æ¹¾èŠ‚ç‚¹", "ğŸ‡ºğŸ‡¸ ç¾å›½èŠ‚ç‚¹", "ğŸ‡¯ğŸ‡µ æ—¥æœ¬èŠ‚ç‚¹", "ğŸ‡¸ğŸ‡¬ æ–°åŠ å¡èŠ‚ç‚¹"]

  - name: "ğŸ‘¨ğŸ¿â€ğŸ’» GitHub"
    type: select
    proxies: ["ğŸš€ æ‰‹åŠ¨é€‰æ‹©", "ğŸ‡­ğŸ‡° é¦™æ¸¯èŠ‚ç‚¹", "ğŸ‡¸ğŸ‡¬ æ–°åŠ å¡èŠ‚ç‚¹"]

  - name: "ğŸŸ æ¼ç½‘ä¹‹é±¼"
    type: select
    proxies: ["ğŸš€ æ‰‹åŠ¨é€‰æ‹©", "â™»ï¸ è‡ªåŠ¨é€‰æ‹©", "DIRECT"]

  - name: "ğŸŒ å…¶ä»–åœ°åŒº"
    type: select
    proxies: ["DIRECT"]
    use: [All_Subscription]
    filter: "^(?!.*(?i)(æ¸¯|HK|ç¾|US|æ—¥æœ¬|JP|æ–°åŠ å¡|SG|å¾·|DE|éŸ©|KR|è‹±|UK|åŠ |CA|å°|TW|racknerd)).*"

# =========================
# 4. åˆ†æµè§„åˆ™
# =========================
rules:
  # --- WebRTC / STUN é˜»æ–­ (Hansé…ç½®çš„ç²¾åï¼Œé˜²æ­¢çœŸå®IPæ³„æ¼) ---
  - DOMAIN-SUFFIX,stun.l.google.com,REJECT
  - DOMAIN-KEYWORD,stun,REJECT
  - DOMAIN-KEYWORD,turn,REJECT
  # æ³¨æ„ï¼šå¦‚æœä½ ç©P2Pæ¸¸æˆé‡åˆ°é—®é¢˜ï¼Œå¯èƒ½éœ€è¦æš‚æ—¶ç¦ç”¨ä¸‹é¢è¿™æ¡
  - DOMAIN-KEYWORD,rtc,REJECT

  # å±€åŸŸç½‘ç›´è¿
  - RULE-SET,private_ip,DIRECT,no-resolve
  - RULE-SET,private_domain,DIRECT
  
  # --- è‡ªå®šä¹‰ç›´è¿ ---
  - RULE-SET,Flying_Direct,DIRECT
  - RULE-SET,Custom_Direct,DIRECT
  - RULE-SET,Steam_CDN,DIRECT
  
  # å¸¸ç”¨ç›´è¿
  - RULE-SET,apple_domain,DIRECT
  - RULE-SET,cn_domain,DIRECT
  - RULE-SET,cn_ip,DIRECT,no-resolve

  # --- è‡ªå®šä¹‰ä»£ç† ---
  - RULE-SET,Flying_Proxy,ğŸš€ æ‰‹åŠ¨é€‰æ‹©
  - RULE-SET,Custom_Proxy,ğŸš€ æ‰‹åŠ¨é€‰æ‹©

  # åº”ç”¨åˆ†æµ
  - RULE-SET,github_domain,ğŸ‘¨ğŸ¿â€ğŸ’» GitHub
  - RULE-SET,youtube_domain,ğŸ‡¬ è°·æ­ŒæœåŠ¡
  - RULE-SET,google_domain,ğŸ‡¬ è°·æ­ŒæœåŠ¡
  - RULE-SET,google_ip,ğŸ‡¬ è°·æ­ŒæœåŠ¡,no-resolve
  
  - RULE-SET,netflix_domain,ğŸ¥ Netflix
  - RULE-SET,netflix_ip,ğŸ¥ Netflix,no-resolve
  
  - RULE-SET,microsoft_domain,â“‚ï¸ å¾®è½¯æœåŠ¡
  - RULE-SET,telegram_domain,ğŸš€ æ‰‹åŠ¨é€‰æ‹©
  - RULE-SET,telegram_ip,ğŸš€ æ‰‹åŠ¨é€‰æ‹©
  
  - RULE-SET,geolocation-!cn,ğŸš€ æ‰‹åŠ¨é€‰æ‹©
  
  # å…œåº•
  - MATCH,ğŸŸ æ¼ç½‘ä¹‹é±¼

# =========================
# 5. DNS è®¾ç½® (å¼•å…¥ Policy åˆ†æµ)
# =========================
dns:
  enable: true
  ipv6: false
  listen: 0.0.0.0:1053
  enhanced-mode: fake-ip
  fake-ip-range: 198.18.0.1/16
  # ä¼˜åŒ–çš„ Fake-IP è¿‡æ»¤åˆ—è¡¨
  fake-ip-filter:
    - "*.lan"
    - "*.local"
    - "stun.*.*"
    - "*.stun.*"
    - "*.msftconnecttest.com"
    - "*.msftncsi.com"
  
  cache-algorithm: arc
  
  default-nameserver:
    - 223.5.5.5
    - 119.29.29.29

  # é»˜è®¤ DNS (å…œåº•ç”¨ï¼Œé€šå¸¸æ˜¯å›½å¤–)
  nameserver:
    - https://1.1.1.1/dns-query
    - https://8.8.8.8/dns-query

  # æ ¸å¿ƒä¼˜åŒ–ï¼šNameserver Policy (ç²¾å‡†åˆ†æµ)
  # å›½å†…åŸŸå -> å¼ºåˆ¶èµ°å›½å†… DNS (é€Ÿåº¦å¿«)
  # å›½å¤–åŸŸå -> å¼ºåˆ¶èµ°å›½å¤– DNS (é˜²æ±¡æŸ“)
  nameserver-policy:
    "geosite:cn,private":
      - https://doh.pub/dns-query
      - https://dns.alidns.com/dns-query
    "geosite:geolocation-!cn":
      - https://1.1.1.1/dns-query
      - https://8.8.8.8/dns-query

  # Fallback (ä½œä¸º Policy çš„åŒé‡ä¿é™©)
  fallback:
    - https://1.1.1.1/dns-query
    - https://8.8.8.8/dns-query
    - tls://1.0.0.1:853
    - tls://8.8.4.4:853

  fallback-filter:
    geoip: true
    geoip-code: CN
    ipcidr: [240.0.0.0/4]
